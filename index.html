<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
</head>

<style>
	:root {
		font-size: 2rem;
	}

	p {
		max-width: 1000px;
		width: 100%;
		margin: auto;
		font-size: 125%;
		max-height: 250px;
		overflow-x: auto;
		overflow-y: auto;
	}

	div {
		max-width: 1000px;
		width: 100%;
		margin: auto;
		display: flex;
		justify-content: space-between;
	}

	span {
		width: fit-content;
		max-width: fit-content;
	}

	hr {
		max-width: 1000px;
		width: 100%;
	}

	textarea {
		max-width: 1000px;
		width: 100%;
		height: 150px;
		resize: none;
		margin: auto;
		font-size: 100%;
	}

	.form-wrapper {
		max-width: 1000px;
		width: 100%;
		margin: 10px auto;
		margin-bottom: 15px;
		display: flex;
		flex-direction: column;
		gap: 7.5px;
	}

	.form-wrapper input,
	.form-wrapper textarea {
		width: 100%;
		font-size: 100%;
		box-sizing: border-box;
	}

	.form-wrapper textarea {
		min-height: 120px;
		resize: vertical;
	}
</style>

<body>
	<div class="form-wrapper">
		<input id="username" placeholder="Name">
		<input id="password" type="password" placeholder="Passwort">
		<textarea id="postcontent" placeholder="Dein Post..."></textarea>
	</div>
	<div style="margin-bottom: 25px;">
		<button onclick="createPost()" style="font-size: 100%; width: 100%; max-width: 1000px; padding: 0px; margin: 0px;">Post</button>
	</div>

	<div id="content" style="display: inline; padding-bottom: 25px;">
	</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
	const { createClient } = window.supabase;

	const supabaseClient = createClient(
		"https://sjowpmjbcguymipdofsu.supabase.co",
		"sb_publishable_Eb-EZRz067MGzEyixtvCSQ_e2vC_gAQ"
	);

	async function loadPosts() {
		document.getElementById("content").innerHTML = "";

		var { data: posts, error: postsError } = await supabaseClient
			.from("Posts")
			.select("*")
			.order("created_at", { ascending: false })
			.range(0, 20);

		for (var i = 0; i < posts.length; i++) {
			var date = new Date(posts[i].created_at);
			var topContainer = document.createElement("div");

			var { data: user, error: userError } = await supabaseClient
				.from("Users")
				.select("*")
				.eq("id", posts[i].user_id)
				.order("created_at", { ascending: true })
				.range(0, 1);
			user = user[0];

			var usersP = document.createElement("span");
			usersP.innerText = user.name;
			topContainer.appendChild(usersP);
			var dateP = document.createElement("span");
			dateP.innerText = date.toLocaleString("de-de");
			topContainer.appendChild(dateP);
			var contentP = document.createElement("p");
			contentP.innerText = posts[i].content

			document.getElementById("content").appendChild(topContainer);
			document.getElementById("content").appendChild(contentP);
			if (i < posts.length - 1)
				document.getElementById("content").appendChild(document.createElement("hr"));
		}
	}

	async function createPost() {
		var username = document.getElementById("username").value;
		var password = document.getElementById("password").value;
		var content = document.getElementById("postcontent").value;

		var { data: user, error: userError } = await supabaseClient
			.from("Users")
			.select("*")
			.eq("name", username)
			.order("created_at", { ascending: true })
			.range(0, 1);

		user = user[0];
		console.log("Id: ", user);
		if (user && password == user.password && content.length > 0) {
			await supabaseClient
				.from("Posts")
				.insert([{ user_id: user.id, content: content }]);
			loadPosts();
			document.getElementById("postcontent").value = "";
		}
		else if (!user && username.length > 0 && password.length > 0 && content.length > 0) {
			await supabaseClient
				.from("Users")
				.insert([{ name: username, password: password }]);
			var { data: user, error: userError } = await supabaseClient
				.from("Users")
				.select("*")
				.eq("name", username)
				.order("created_at", { ascending: true })
				.range(0, 1);
			user = user[0];
			await supabaseClient
				.from("Posts")
				.insert([{ user_id: user.id, content: content }]);
			loadPosts();
			document.getElementById("postcontent").value = "";
		}
		else {
			alert("Fehler beim Posten.\nBitte füll jedes Feld aus und gib gültige Anmeldedaten ein.")
		}
	}

	loadPosts();
</script>
</html>
