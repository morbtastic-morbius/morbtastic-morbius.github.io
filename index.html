<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
</head>

<style>
	p {
		max-width: 1000px;
		width: 100%;
		margin: auto;
		font-size: 16pt;
	}
	div {
		max-width: 1000px;
		width: 100%;
		margin: auto;
		display: flex;
		justify-content: space-between;
	}
	span {
		width: fit-content;
		max-width: fit-content;
	}
	hr {
		max-width: 1000px;
		width: 100%;
	}
	textarea {
		max-width: 1000px;
		width: 95vw;
		height: 150px;
		resize: none;
		margin: auto;
	}
</style>

<body>

	<div style="max-width: 1000px; width: 95vw; margin: auto; display: grid; margin-bottom: 25px; margin-top: 10px;">
		<span style="max-width: 1000px; width: 95vw; justify-content: space-between; margin-bottom: 10px;">
			<div>
				<span>
					<input id="username" placeholder="Name">
					<input id="password" placeholder="Passwort">
				</span>
				<button onclick="createPost()">Post</button>
			</div>
		</span>
		<textarea id="postcontent" placeholder="Write something..."></textarea>
	</div>
	<div id="content" style="display: inline;">
	</div>

</body>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = window.supabase;

const supabaseClient = createClient(
	"https://sjowpmjbcguymipdofsu.supabase.co",
	"sb_publishable_Eb-EZRz067MGzEyixtvCSQ_e2vC_gAQ"
);

async function getPosts() {
  const { data: data, error: error } = await supabaseClient
    .from("Posts")
    .select("*")
	.order("created_at", { ascending: false });
  return data;
}
async function getUsers() {
  const { data: data, error: error } = await supabaseClient
    .from("Users")
    .select("*");
  return data;
}

var posts; var users;
async function init() {
  posts = await getPosts();
  users = await getUsers();

}

async function loadPosts() {

		document.getElementById("content").innerHTML = "";

		const { data: users, error: usersError } = await supabaseClient
		.from("Users")
		.select("*");
  
		const { data: posts, error: postsError } = await supabaseClient
		.from("Posts")
		.select("*")
		.order("created_at", { ascending: false });

	for (var i = 0; i < posts.length; i++) {
		var date = new Date(posts[i].created_at);
		var topContainer = document.createElement("div");

		var usersP = document.createElement("span");
		usersP.innerText = users[posts[i].user_id - 1].name;
		topContainer.appendChild(usersP);
		var dateP = document.createElement("span");
		dateP.innerText = date.toLocaleString("de-de");
		topContainer.appendChild(dateP);
		var contentP = document.createElement("p");
		contentP.innerText = posts[i].content

		document.getElementById("content").appendChild(topContainer);
		document.getElementById("content").appendChild(contentP);
		if (i < posts.length - 1)
			document.getElementById("content").appendChild(document.createElement("hr"));
	}
}

async function createPost() {
		const { data: users, error: usersError } = await supabaseClient
		.from("Users")
		.select("*");
  
		const { data: posts, error: postsError } = await supabaseClient
		.from("Posts")
		.select("*")
		.order("created_at", { ascending: false });
  
	var username = document.getElementById("username").value;
	var password = document.getElementById("password").value;
	var content = document.getElementById("postcontent").value;
	var index = users.findIndex(function fn(x) { return (username == x["name"]); });

	if (index >= 0 && password == users[index]["password"] && content.length > 0) {
		await supabaseClient
			.from("Posts")
			.insert([{ id: posts.length + 1, user_id: index + 1, content: content }]);
		loadPosts();
	}
	else if (index < 0 && username.length > 0 && password.length > 0 && content.length > 0) {
		console.log(content.length);
		await supabaseClient
			.from("Users")
			.insert([{ id: users.length + 1, name: username, password: password }]);
		await supabaseClient
			.from("Posts")
			.insert([{ id: posts.length + 1, user_id: users.length, content: content }]);
		loadPosts();
	}
}

loadPosts();
init();

</script>
</html>
